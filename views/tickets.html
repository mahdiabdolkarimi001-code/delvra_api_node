<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù…Ø¯ÛŒØ±ÛŒØª ØªÛŒÚ©Øªâ€ŒÙ‡Ø§ - Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ†</title>
  <!-- ÙÙˆÙ†Øª Vazirmatn -->
  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/web/fonts/Vazirmatn-Regular.woff2" rel="preload" as="font" crossorigin>
  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/web/fonts/Vazirmatn-Bold.woff2" rel="preload" as="font" crossorigin>
  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/web/fonts/Vazirmatn-Light.woff2" rel="preload" as="font" crossorigin>
  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/web/fonts/Vazirmatn-Medium.woff2" rel="preload" as="font" crossorigin>

  <!-- CSS -->
  <link rel="stylesheet" href="tickets.css">
</head>
<body>
  <div class="container">
    <h1>ğŸ“© Ù„ÛŒØ³Øª ØªÛŒÚ©Øªâ€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h1>

    <table id="tickets-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Ù†Ø§Ù…</th>
          <th>Ø§ÛŒÙ…ÛŒÙ„</th>
          <th>Ù…ÙˆØ¶ÙˆØ¹</th>
          <th>Ù¾ÛŒØ§Ù…</th>
          <th>Ù¾Ø§Ø³Ø® Ø§Ø¯Ù…ÛŒÙ†</th>
          <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
        </tr>
      </thead>
      <tbody>
        <!-- Ù¾Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ø¨Ø§ JS -->
      </tbody>
    </table>

    <div class="logout">
      <a href="/dashboard">ğŸ  Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</a>
      <span>|</span>
      <a href="/logout">ğŸšª Ø®Ø±ÙˆØ¬</a>
    </div>
  </div>

  <script>
    // Ú¯Ø±ÙØªÙ† Ù„ÛŒØ³Øª ØªÛŒÚ©Øªâ€ŒÙ‡Ø§ Ø§Ø² API
    async function loadTickets() {
      try {
        const res = await fetch("/api/tickets/admin");
        const data = await res.json();
        const tbody = document.querySelector("#tickets-table tbody");
        tbody.innerHTML = "";

        if (!data.success) {
          tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; color:red;">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªÛŒÚ©Øªâ€ŒÙ‡Ø§!</td></tr>`;
          return;
        }

        if (data.tickets.length === 0) {
          tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; color:#555;">Ù‡ÛŒÚ† ØªÛŒÚ©ØªÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</td></tr>`;
          return;
        }

        data.tickets.forEach(ticket => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${ticket.id}</td>
            <td>${ticket.user_name}</td>
            <td>${ticket.user_email}</td>
            <td>${ticket.subject}</td>
            <td class="message-cell">${ticket.message}</td>
            <td class="response-cell">${ticket.admin_response || "â³ Ù‡Ù†ÙˆØ² Ù¾Ø§Ø³Ø®ÛŒ Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯Ù‡"}</td>
            <td class="action-cell">
              <form onsubmit="return sendResponse(event, ${ticket.id})">
                <textarea name="response" placeholder="Ù¾Ø§Ø³Ø®..." ${ticket.admin_response ? 'disabled' : ''} required></textarea>
                <button type="submit" ${ticket.admin_response ? 'disabled style="background:#95a5a6; cursor:not-allowed;"' : ''}>${ticket.admin_response ? 'Ù¾Ø§Ø³Ø® Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡' : 'Ø§Ø±Ø³Ø§Ù„ Ù¾Ø§Ø³Ø®'}</button>
              </form>
            </td>
          `;
          tbody.appendChild(tr);
        });

      } catch (err) {
        console.error("Ø®Ø·Ø§ Ø¯Ø± Ú¯Ø±ÙØªÙ† ØªÛŒÚ©Øªâ€ŒÙ‡Ø§:", err);
        const tbody = document.querySelector("#tickets-table tbody");
        tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; color:red;">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªÛŒÚ©Øªâ€ŒÙ‡Ø§. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯.</td></tr>`;
      }
    }

    // Ø§Ø±Ø³Ø§Ù„ Ù¾Ø§Ø³Ø® Ø§Ø¯Ù…ÛŒÙ†
    async function sendResponse(event, ticketId) {
      event.preventDefault();
      const textarea = event.target.querySelector("textarea");
      const response = textarea.value.trim();
      if (!response) {
        alert("Ù„Ø·ÙØ§Ù‹ Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ Ù¾Ø§Ø³Ø®ÛŒ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯!");
        return false;
      }

      try {
        const res = await fetch("/api/tickets/admin/respond", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ticketId, response }),
        });
        const data = await res.json();
        if (data.success) {
          alert("âœ… Ù¾Ø§Ø³Ø® Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯!");
          loadTickets();
        } else {
          alert("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾Ø§Ø³Ø®: " + (data.message || "Ù…Ø´Ú©Ù„ÛŒ Ù¾ÛŒØ´ Ø¢Ù…Ø¯."));
        }
      } catch (err) {
        console.error("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾Ø§Ø³Ø®:", err);
        alert("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾Ø§Ø³Ø®: Ù…Ø´Ú©Ù„ Ø´Ø¨Ú©Ù‡ ÛŒØ§ Ø³Ø±ÙˆØ±.");
      }
      return false;
    }

    document.addEventListener("DOMContentLoaded", loadTickets);
  </script>
</body>
</html>
